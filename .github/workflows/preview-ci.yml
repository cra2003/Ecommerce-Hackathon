name: Preview CI/CD

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================
  # 1. Detect Changed Workers
  # ============================================
  detect-changes:
    name: Detect Changed Workers
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.changes.outputs.workers }}
      workers-json: ${{ steps.changes.outputs.workers-json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for change detection

      - name: Detect changed workers
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For workflow_dispatch, compare against main branch
            git fetch origin main || true
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Define all workers
          WORKERS="auth-worker cart-worker cart-cron-worker order-worker payment-worker fullfilment-worker price-worker product-worker"
          
          # Detect which workers have changes
          CHANGED_WORKERS=""
          for worker in $WORKERS; do
            if echo "$CHANGED_FILES" | grep -q "^$worker/"; then
              CHANGED_WORKERS="$CHANGED_WORKERS $worker"
              echo "âœ… $worker has changes"
            else
              echo "â­ï¸  $worker has no changes, skipping"
            fi
          done
          
          # Trim leading space
          CHANGED_WORKERS=$(echo "$CHANGED_WORKERS" | xargs)
          
          if [ -z "$CHANGED_WORKERS" ]; then
            echo "âš ï¸  No workers changed, nothing to deploy"
            echo "workers=" >> $GITHUB_OUTPUT
            echo "workers-json=[]" >> $GITHUB_OUTPUT
          else
            echo "Changed workers: $CHANGED_WORKERS"
            echo "workers=$CHANGED_WORKERS" >> $GITHUB_OUTPUT
            
            # Create JSON array for matrix
            JSON_ARRAY="["
            FIRST=true
            for worker in $CHANGED_WORKERS; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                JSON_ARRAY="$JSON_ARRAY,"
              fi
              JSON_ARRAY="$JSON_ARRAY\"$worker\""
            done
            JSON_ARRAY="$JSON_ARRAY]"
            echo "workers-json=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # 2. Setup & Install Dependencies
  # ============================================
  setup:
    name: Setup & Install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

  # ============================================
  # 3. Lint Check
  # ============================================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

  # ============================================
  # 4. Format Check
  # ============================================
  format:
    name: Format Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

  # ============================================
  # 5. Knip Check (Non-blocking)
  # ============================================
  knip:
    name: Knip Check (Non-blocking)
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run knip
        run: |
          # Run knip for workers that have it configured
          WORKERS="auth-worker cart-worker cart-cron-worker order-worker payment-worker fullfilment-worker price-worker product-worker"
          HAS_ERRORS=false
          
          for worker in $WORKERS; do
            if [ -f "$worker/package.json" ] && grep -q '"knip"' "$worker/package.json"; then
              echo "ðŸ” Running knip for $worker..."
              cd "$worker"
              if npm run knip 2>&1; then
                echo "âœ… $worker: knip passed"
              else
                echo "âš ï¸  $worker: knip found issues (non-blocking)"
                HAS_ERRORS=true
              fi
              cd ..
            else
              echo "â­ï¸  $worker: no knip script, skipping"
            fi
          done
          
          if [ "$HAS_ERRORS" = true ]; then
            echo "âš ï¸  Some workers have knip issues (non-blocking)"
          fi

  # ============================================
  # 6. Tests (Optional/Placeholder)
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          # Run tests for all workers that have test scripts
          WORKERS="auth-worker cart-worker cart-cron-worker order-worker payment-worker fullfilment-worker price-worker product-worker"
          HAS_TESTS=false
          
          for worker in $WORKERS; do
            if [ -f "$worker/package.json" ] && grep -q '"test"' "$worker/package.json"; then
              echo "ðŸ§ª Running tests for $worker..."
              cd "$worker"
              if npm test 2>&1; then
                echo "âœ… $worker: tests passed"
                HAS_TESTS=true
              else
                echo "âŒ $worker: tests failed"
                exit 1
              fi
              cd ..
            fi
          done
          
          if [ "$HAS_TESTS" = false ]; then
            echo "â„¹ï¸  No tests found, skipping test step"
          fi

  # ============================================
  # 7. Deploy to Preview (Only Changed Workers)
  # ============================================
  deploy-preview:
    name: Deploy Preview (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, format, test]
    if: needs.detect-changes.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache Wrangler
        uses: actions/cache@v4
        with:
          path: |
            ${{ matrix.worker }}/.wrangler
            ~/.wrangler
          key: ${{ runner.os }}-wrangler-${{ matrix.worker }}-${{ hashFiles(format('{0}/wrangler.toml', matrix.worker)) }}
          restore-keys: |
            ${{ runner.os }}-wrangler-${{ matrix.worker }}-

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Preview
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸš€ Deploying ${{ matrix.worker }} to preview environment..."
          cd "${{ matrix.worker }}"
          
          # Check if preview environment exists in wrangler.toml
          if grep -q "\[env.preview\]" wrangler.toml; then
            echo "âœ… Preview environment found in wrangler.toml"
            npx wrangler deploy --env preview
          else
            echo "âš ï¸  No preview environment in wrangler.toml, deploying to default"
            npx wrangler deploy
          fi
          
          echo "âœ… Successfully deployed ${{ matrix.worker }}"

      - name: Deployment Summary
        run: |
          echo "âœ… Successfully deployed ${{ matrix.worker }} to preview"
          echo "ðŸŒ Preview URL: https://${{ matrix.worker }}-preview.aadhi18082003.workers.dev"

  # ============================================
  # 8. Summary Job
  # ============================================
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, format, knip, test, deploy-preview]
    if: always()
    steps:
      - name: Print Summary
        run: |
          echo "## ðŸ“Š CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Changed workers
          if [ "${{ needs.detect-changes.outputs.workers }}" != "" ]; then
            echo "### Changed Workers" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.detect-changes.outputs.workers }}" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "### Changed Workers" >> $GITHUB_STEP_SUMMARY
            echo "- No workers changed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Format: ${{ needs.format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Knip: ${{ needs.knip.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy-preview.result }}" >> $GITHUB_STEP_SUMMARY

