name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # -------------------------------
  # 0) Detect Changd Workers (runs in parallel with CI)
  # -------------------------------
  detect-changes:
    name: Detect Changed Workers
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.changes.outputs.workers }}
      workers-json: ${{ steps.changes.outputs.workers-json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed workers
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, compare with the previous commit in the same branch
            # The issue: HEAD~1 might point to main if feature branch was created from main
            # Solution: Find the previous commit that's actually in the feature branch
            
            CURRENT_BRANCH="${{ github.ref_name }}"
            echo "Current branch: $CURRENT_BRANCH"
            echo "Current SHA (HEAD): ${{ github.sha }}"
            
            # Fetch main to compare against it
            git fetch origin main:main 2>/dev/null || true
            
            # Find the merge-base with main (where feature branch diverged from main)
            MERGE_BASE=""
            if git rev-parse --verify main >/dev/null 2>&1; then
              MERGE_BASE=$(git merge-base main HEAD 2>/dev/null || echo "")
              echo "Merge-base with main: $MERGE_BASE"
            fi
            
            # Try to find the previous commit in the feature branch (not on main)
            PREV_COMMIT=""
            
            # If HEAD~1 exists and is different from merge-base, use it
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              HEAD_MINUS_1=$(git rev-parse HEAD~1)
              echo "HEAD~1: $HEAD_MINUS_1"
              
              # If HEAD~1 is not the merge-base (meaning it's in the feature branch), use it
              if [ -z "$MERGE_BASE" ] || [ "$HEAD_MINUS_1" != "$MERGE_BASE" ]; then
                PREV_COMMIT="HEAD~1"
                echo "Using HEAD~1 as previous commit (it's in feature branch)"
              else
                echo "HEAD~1 is on main, cannot use it"
              fi
            fi
            
            # If we found a previous commit, use it; otherwise show all files in current commit
            if [ -n "$PREV_COMMIT" ]; then
              PREV_SHA=$(git rev-parse $PREV_COMMIT)
              echo "Comparing: $PREV_COMMIT ($PREV_SHA)..HEAD (${{ github.sha }})"
              CHANGED_FILES=$(git diff --name-only $PREV_COMMIT HEAD)
            else
              # First commit in branch or HEAD~1 is on main - show all files in current commit
              echo "No previous commit found in feature branch, showing all files in current commit"
              CHANGED_FILES=$(git show --pretty="" --name-only HEAD)
            fi
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Define all workers
          WORKERS="auth-worker cart-worker cart-cron-worker order-worker payment-worker fullfilment-worker price-worker product-worker"
          
          # Detect which workers have changes
          CHANGED_WORKERS=""
          for worker in $WORKERS; do
            if echo "$CHANGED_FILES" | grep -q "^$worker/"; then
              CHANGED_WORKERS="$CHANGED_WORKERS $worker"
              echo "‚úÖ $worker has changes"
            else
              echo "‚è≠Ô∏è  $worker has no changes, skipping"
            fi
          done
          
          # Trim leading space
          CHANGED_WORKERS=$(echo "$CHANGED_WORKERS" | xargs)
          
          if [ -z "$CHANGED_WORKERS" ]; then
            echo "‚ö†Ô∏è  No workers changed, nothing to deploy"
            echo "workers=" >> $GITHUB_OUTPUT
            echo "workers-json=[]" >> $GITHUB_OUTPUT
          else
            echo "Changed workers: $CHANGED_WORKERS"
            echo "workers=$CHANGED_WORKERS" >> $GITHUB_OUTPUT
            
            # Create JSON array for matrix
            JSON_ARRAY="["
            FIRST=true
            for worker in $CHANGED_WORKERS; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                JSON_ARRAY="$JSON_ARRAY,"
              fi
              JSON_ARRAY="$JSON_ARRAY\"$worker\""
            done
            JSON_ARRAY="$JSON_ARRAY]"
            echo "workers-json=$JSON_ARRAY" >> $GITHUB_OUTPUT
          fi
  # -------------------------------
  # 1) CI Checks (runs in parallel with detect-changes)
  # -------------------------------
  ci:
    name: CI Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            **/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Run tests
        run: npm test

      - name: Run knip (non-blocking)
        continue-on-error: true
        run: |
          WORKERS="auth-worker cart-worker cart-cron-worker order-worker payment-worker fullfilment-worker price-worker product-worker"
          HAS_ERRORS=false
          
          for worker in $WORKERS; do
            if [ -f "$worker/package.json" ] && grep -q '"knip"' "$worker/package.json"; then
              echo "üîç Running knip for $worker..."
              cd "$worker"
              if npm run knip 2>&1; then
                echo "‚úÖ $worker: knip passed"
              else
                echo "‚ö†Ô∏è  $worker: knip found issues (non-blocking)"
                HAS_ERRORS=true
              fi
              cd ..
            fi
          done
          
          if [ "$HAS_ERRORS" = true ]; then
            echo "‚ö†Ô∏è  Some workers have knip issues (non-blocking)"
          fi

  # -------------------------------
  # 2) Preview Deploy for PRs
  # -------------------------------
  preview_deploy:
    name: Deploy Preview (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, ci]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    continue-on-error: true
    outputs:
      deploy_status: ${{ steps.deploy_preview.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Preview Environment
        id: deploy_preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ matrix.worker }}
          command: deploy --env preview

      - name: Slack Notify ‚Äî Preview Deploy Failed
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"‚ùå *Preview deploy FAILED for ${{ matrix.worker }}* (PR #${{ github.event.pull_request.number }})\"}" \
              $SLACK_WEBHOOK_URL || true
          fi

      - name: Slack Notify ‚Äî Preview Deploy Success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"‚úÖ *Preview deploy succeeded for ${{ matrix.worker }}* (PR #${{ github.event.pull_request.number }})\nüåê https://${{ matrix.worker }}-preview.aadhi18082003.workers.dev\"}" \
              $SLACK_WEBHOOK_URL || true
          fi

  # -------------------------------
  # 2.5) Preview Health Check (per worker)
  # -------------------------------
  preview_health_check:
    name: Preview Health Check (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, preview_deploy]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    continue-on-error: true
    steps:
      - name: Wait before preview health check
        run: sleep 10

      - name: Check preview health
        id: check
        run: |
          echo "Running preview health check for ${{ matrix.worker }}..."
          WORKER_NAME="${{ matrix.worker }}"
          
          # Construct URL from worker name
          if [ "$WORKER_NAME" = "order-worker" ]; then
            URL="https://orders-worker-preview.aadhi18082003.workers.dev/health"
          elif [ "$WORKER_NAME" = "product-worker" ]; then
            URL="https://products-worker-preview.aadhi18082003.workers.dev/health"
          else
            URL="https://${WORKER_NAME}-preview.aadhi18082003.workers.dev/health"
          fi
          
          echo "Checking health at: $URL"
          if curl -f --max-time 30 "$URL"; then
            echo "‚úÖ Health check passed for $WORKER_NAME"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health check failed for $WORKER_NAME"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "$WORKER_NAME" >> failed_workers.txt
            exit 1
          fi

      - name: Upload failed worker marker
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-worker-${{ matrix.worker }}-preview
          path: failed_workers.txt
          if-no-files-found: ignore
          retention-days: 1

  # -------------------------------
  # 2.6) Automatic Preview Rollback (per worker - only if that worker's health check failed)
  # -------------------------------
  rollback_preview:
    name: Rollback Preview (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, preview_health_check]
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.workers != '' &&
      needs.preview_health_check.result != 'success'
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download failed worker artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: failed-worker-*-preview
          path: failed-workers
          if-no-files-found: ignore
          merge-multiple: true

      - name: Check if this worker needs rollback
        id: should_rollback
        run: |
          WORKER_NAME="${{ matrix.worker }}"
          # Check if this worker's artifact directory exists (meaning it failed)
          if [ -d "failed-workers/failed-worker-${WORKER_NAME}-preview" ]; then
            echo "‚úÖ $WORKER_NAME health check failed - will rollback"
            echo "rollback=true" >> $GITHUB_OUTPUT
          elif [ -d "failed-workers" ] && find failed-workers -name "*${WORKER_NAME}*" -type d | grep -q .; then
            echo "‚úÖ $WORKER_NAME health check failed - will rollback"
            echo "rollback=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  $WORKER_NAME health check passed - skipping rollback"
            echo "rollback=false" >> $GITHUB_OUTPUT
          fi

      - name: Rollback preview to previous version
        if: steps.should_rollback.outputs.rollback == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ matrix.worker }}
          command: rollback --env preview

      - name: Slack Notify ‚Äî Preview Auto Rollback
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"‚ö†Ô∏è *Preview health FAILED for ${{ matrix.worker }}* ‚Äî auto rollback executed (PR #${{ github.event.pull_request.number }}).\"}" \
              $SLACK_WEBHOOK_URL || true
          fi

  # -------------------------------
  # 3) Production Deploy
  # -------------------------------
  deploy_prod:
    name: Deploy to Production (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, ci]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.detect-changes.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    continue-on-error: true
    outputs:
      deploy_status: ${{ steps.deploy_prod.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production
        id: deploy_prod
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ matrix.worker }}
          command: deploy

      - name: Slack Notify ‚Äî Prod Deploy Failed
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"‚ùå *Production deploy FAILED for ${{ matrix.worker }}!*\nCommit: ${{ github.sha }} by ${{ github.actor }}\"}" \
              $SLACK_WEBHOOK_URL || true
          fi

      - name: Slack Notify ‚Äî Prod Deploy Success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            WORKER_NAME="${{ matrix.worker }}"
            if [ "$WORKER_NAME" = "order-worker" ]; then
              URL="https://orders-worker.aadhi18082003.workers.dev/health"
            elif [ "$WORKER_NAME" = "product-worker" ]; then
              URL="https://products-worker.aadhi18082003.workers.dev/health"
            else
              URL="https://${WORKER_NAME}.aadhi18082003.workers.dev/health"
            fi
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"‚úÖ *Production deploy succeeded for ${{ matrix.worker }}!*\nüåê $URL\"}" \
              $SLACK_WEBHOOK_URL || true
          fi

  # -------------------------------
  # 3.5) Production Health Check (per worker)
  # -------------------------------
  health_check_prod:
    name: Production Health Check (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy_prod]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.detect-changes.outputs.workers != ''
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    continue-on-error: true
    steps:
      - name: Wait before health check
        run: sleep 10

      - name: Check production health
        id: check
        run: |
          echo "Running production health check for ${{ matrix.worker }}..."
          WORKER_NAME="${{ matrix.worker }}"
          
          # Construct URL from worker name
          if [ "$WORKER_NAME" = "order-worker" ]; then
            URL="https://orders-worker.aadhi18082003.workers.dev/health"
          elif [ "$WORKER_NAME" = "product-worker" ]; then
            URL="https://products-worker.aadhi18082003.workers.dev/health"
          else
            URL="https://${WORKER_NAME}.aadhi18082003.workers.dev/health"
          fi
          
          echo "Checking health at: $URL"
          if curl -f --max-time 30 "$URL"; then
            echo "‚úÖ Health check passed for $WORKER_NAME"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health check failed for $WORKER_NAME"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "$WORKER_NAME" >> failed_workers.txt
            exit 1
          fi

      - name: Upload failed worker marker
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-worker-${{ matrix.worker }}-prod
          path: failed_workers.txt
          if-no-files-found: ignore
          retention-days: 1

  # -------------------------------
  # 3.6) Automatic Production Rollback (per worker - only if that worker's health check failed)
  # -------------------------------
  rollback_prod:
    name: Rollback Production (${{ matrix.worker }})
    runs-on: ubuntu-latest
    needs: [detect-changes, health_check_prod]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.detect-changes.outputs.workers != '' &&
      needs.health_check_prod.result != 'success'
    strategy:
      matrix:
        worker: ${{ fromJson(needs.detect-changes.outputs.workers-json) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download failed worker artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: failed-worker-*-prod
          path: failed-workers
          if-no-files-found: ignore
          merge-multiple: true

      - name: Check if this worker needs rollback
        id: should_rollback
        run: |
          WORKER_NAME="${{ matrix.worker }}"
          # Check if this worker's artifact directory exists (meaning it failed)
          if [ -d "failed-workers/failed-worker-${WORKER_NAME}-preview" ]; then
            echo "‚úÖ $WORKER_NAME health check failed - will rollback"
            echo "rollback=true" >> $GITHUB_OUTPUT
          elif [ -d "failed-workers" ] && find failed-workers -name "*${WORKER_NAME}*" -type d | grep -q .; then
            echo "‚úÖ $WORKER_NAME health check failed - will rollback"
            echo "rollback=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  $WORKER_NAME health check passed - skipping rollback"
            echo "rollback=false" >> $GITHUB_OUTPUT
          fi

      - name: Rollback to previous version
        if: steps.should_rollback.outputs.rollback == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ matrix.worker }}
          command: rollback

      - name: Slack Notify ‚Äî PROD Auto Rollback
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\": \"üö® *PRODUCTION HEALTH FAILED for ${{ matrix.worker }}* ‚Äî Auto rollback executed.\nüîÅ System restored to last working version.\"}" \
              $SLACK_WEBHOOK_URL || true
          fi
