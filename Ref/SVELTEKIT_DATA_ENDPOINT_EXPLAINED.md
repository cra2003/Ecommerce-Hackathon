# SvelteKit `__data.json` Endpoint Explained

## What is `__data.json`?

`__data.json` is a **SvelteKit internal endpoint** that serves page data from your `+page.server.js` `load` function. It's automatically generated by SvelteKit to enable client-side navigation and data invalidation.

## The URL Breakdown

```
http://localhost:5173/products/__data.json?x-sveltekit-invalidated=01
```

- **`/products/`** - The route path
- **`__data.json`** - SvelteKit's data endpoint (internal)
- **`x-sveltekit-invalidated=01`** - Invalidation token (changes when data needs refresh)

---

## How It Works

### Step 1: Initial Page Load (SSR)

When you first visit `/products`:

1. **Server-side:** SvelteKit runs `+page.server.js` `load` function
2. **Data fetched:** Products, filters, pagination loaded
3. **HTML rendered:** Server sends HTML with embedded data
4. **No `__data.json` call:** Data is already in the HTML

### Step 2: Client-Side Navigation

When you change filters or pagination:

**File:** `frontend-ui/src/lib/components/FilterSidebar.svelte`

```javascript
function updateFilter(key, value) {
	// Update URL parameters
	const searchParams = new URLSearchParams($currentPage.url.searchParams);
	searchParams.set(key, value);
	searchParams.delete('page'); // Reset to page 1

	const newUrl = `${$currentPage.url.pathname}?${searchParams.toString()}`;

	// Navigate with invalidation
	goto(newUrl, {
		invalidateAll: true, // ← This triggers __data.json request
	});
}
```

**What Happens:**

1. **`goto()` is called** with `invalidateAll: true`
2. **SvelteKit intercepts** the navigation
3. **Instead of full page reload**, it makes a fetch to:
   ```
   GET /products/__data.json?x-sveltekit-invalidated=01
   ```
4. **`+page.server.js` `load` function runs** (server-side)
5. **Fresh data returned** as JSON
6. **Page updates** without full reload (SPA-style)

---

## The `x-sveltekit-invalidated` Parameter

### What It Does

The `x-sveltekit-invalidated=01` parameter is SvelteKit's way of:

- **Tracking data freshness** - Ensures you get the latest data
- **Cache busting** - Prevents browser from serving stale data
- **Version control** - Increments when data is invalidated

### When It Changes

The number changes when:

- You call `goto()` with `invalidateAll: true`
- You call `invalidate()` or `invalidateAll()` programmatically
- URL parameters change (filters, pagination)
- Data dependencies are marked as stale

### Example Flow

```javascript
// Initial load
/products → __data.json?x-sveltekit-invalidated=01

// Filter changed
/products?category=Sneakers → __data.json?x-sveltekit-invalidated=02

// Page changed
/products?category=Sneakers&page=2 → __data.json?x-sveltekit-invalidated=03
```

---

## Complete Request Flow

### Scenario: User Changes Filter

```
┌─────────────────────────────────────────────────────────────┐
│ 1. USER CLICKS FILTER                                        │
│    FilterSidebar.svelte: updateFilter('category', 'Sneakers')│
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. GOTO() CALLED WITH INVALIDATION                           │
│    goto('/products?category=Sneakers', { invalidateAll: true })│
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. SVELTEKIT INTERCEPTS                                      │
│    - Detects navigation                                       │
│    - Sees invalidateAll: true                                 │
│    - Prepares data fetch                                      │
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. FETCH TO __data.json                                       │
│    GET /products/__data.json?x-sveltekit-invalidated=02      │
│    Headers: { Accept: 'application/json' }                    │
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. SERVER RUNS LOAD FUNCTION                                  │
│    +page.server.js: load({ fetch, url })                     │
│    - Reads URL params: category=Sneakers                      │
│    - Fetches filtered products                                │
│    - Fetches price/stock for each product                     │
│    - Returns: { products, pagination, filters }                │
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. JSON RESPONSE RETURNED                                    │
│    {                                                          │
│      products: [...],                                         │
│      pagination: { page: 1, totalPages: 5, ... },            │
│      filters: { categories: [...], ... },                     │
│      activeFilters: { category: 'Sneakers' }                  │
│    }                                                          │
└───────────────────────┬───────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. SVELTEKIT UPDATES PAGE                                    │
│    - Updates URL (no full reload)                              │
│    - Updates $page store                                      │
│    - Re-renders components with new data                      │
│    - Shows loading state during fetch                          │
└─────────────────────────────────────────────────────────────┘
```

---

## Why Use `__data.json` Instead of Full Reload?

### Benefits

1. **Faster Navigation** - No full page reload, just data fetch
2. **Better UX** - Loading states, smooth transitions
3. **State Preservation** - Scroll position, form inputs can be preserved
4. **Efficient** - Only fetches data, not entire HTML

### How It's Different

**Traditional Navigation:**

```
User clicks → Full page reload → Server renders HTML → Browser displays
```

**SvelteKit Navigation:**

```
User clicks → Fetch __data.json → Update page data → Smooth transition
```

---

## Code Examples

### Your Products Page Load Function

**File:** `frontend-ui/src/routes/products/+page.server.js`

```javascript
export async function load({ fetch, url }) {
	// 1. Read URL parameters
	const category = url.searchParams.get('category') || null;
	const page = parseInt(url.searchParams.get('page') || '1', 10);

	// 2. Fetch products with filters
	const productsRes = await fetch(`${PRODUCTS_API}/products?category=${category}&page=${page}`);
	const productsData = await productsRes.json();

	// 3. Enrich with price/stock
	const enrichedProducts = await Promise.all(
		productsData.products.map(async product => {
			const [priceData, stockData] = await Promise.all([
				fetchPriceData(fetch, PRICE_API, product.sku, product.product_id),
				fetchStockData(fetch, FULFILL_API, product.product_id),
			]);
			return { ...product, price: priceData.price, inStock: stockData.total_stock > 0 };
		})
	);

	// 4. Return data (this becomes __data.json response)
	return {
		products: enrichedProducts,
		pagination: productsData.pagination,
		filters: filterOptions,
		activeFilters: { category },
	};
}
```

**When `__data.json` is called:**

- SvelteKit runs this `load` function
- Returns the data as JSON
- Response is served at `/products/__data.json`

---

## When `__data.json` is Called

### Automatic Triggers

1. **Filter Changes** (FilterSidebar.svelte)

   ```javascript
   goto(newUrl, { invalidateAll: true });
   // → __data.json?x-sveltekit-invalidated=02
   ```

2. **Pagination** (Pagination.svelte)

   ```html
   <a href="/products?page=2">Next</a>
   <!-- SvelteKit intercepts → __data.json?x-sveltekit-invalidated=03 -->
   ```

3. **Programmatic Invalidation**

   ```javascript
   import { invalidateAll } from '$app/navigation';
   await invalidateAll(); // → Refetches all __data.json
   ```

4. **URL Parameter Changes**
   - Any change to `?category=`, `?page=`, etc.
   - SvelteKit automatically detects and refetches

---

## The Response Format

When you request `/products/__data.json`, you get:

```json
{
  "status": 200,
  "data": {
    "products": [
      {
        "id": "b4a04fa6-...",
        "name": "UrbanEase Classic",
        "price": 12995,
        "inStock": true,
        "sizes": [8, 9, 10, 11]
      },
      // ... more products
    ],
    "pagination": {
      "page": 1,
      "totalPages": 5,
      "total": 48,
      "hasNext": true,
      "hasPrev": false
    },
    "filters": {
      "categories": ["Sneakers", "Boots", ...],
      "brands": ["Nike", "Adidas", ...],
      "closure_types": ["Lace", "Velcro", ...],
      "sole_materials": ["Rubber", "Leather", ...]
    },
    "activeFilters": {
      "category": "Sneakers",
      "brand": null,
      "closure_type": null,
      "sole_material": null
    }
  }
}
```

---

## Why You See It in Network Tab

When you:

- Change a filter
- Click pagination
- Navigate to products page
- Refresh the page

SvelteKit makes a background fetch to `__data.json` to get fresh data. This is **normal and expected behavior**.

---

## Key Takeaways

1. **`__data.json` is internal** - Generated by SvelteKit automatically
2. **Used for client-side navigation** - Enables SPA-like behavior
3. **`x-sveltekit-invalidated`** - Version token for cache busting
4. **Runs your `load` function** - Executes `+page.server.js` server-side
5. **No full page reload** - Just data fetch and update

---

## Debugging

If you want to see what data is being returned:

```javascript
// In +page.svelte
$effect(() => {
	console.log('Page data:', data);
	// This logs the data from __data.json
});
```

Or check Network tab:

1. Open DevTools → Network
2. Filter by "Fetch/XHR"
3. Look for `__data.json` requests
4. Click on it → Response tab to see the JSON

---

## Summary

The `__data.json` endpoint is SvelteKit's way of:

- ✅ Loading page data without full reloads
- ✅ Enabling smooth client-side navigation
- ✅ Supporting data invalidation
- ✅ Making your app feel like a SPA

It's **completely normal** to see these requests in your network tab when navigating or changing filters!
